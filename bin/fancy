#!/usr/bin/env node

var program = require('commander');
var package = require('../package');
var request = require('request');
var cheerio = require('cheerio');
var async = require('async');
var _ = require('underscore');
var sqlite3 = require('sqlite3').verbose();
var fs = require('fs');
var Fancy = require('../lib/fancy')

var wishlistUrlTemplate = 'http://www.amazon.co.uk/registry/wishlist/${wishlistId}?layout=compact'
var wishlistId = '1QJBF75CZDO9E'
var wishlistUrl = wishlistUrlTemplate.replace('${wishlistId}', wishlistId);

var file = 'db/fancy.db';
var dbExists = fs.existsSync(file);
var db = new sqlite3.Database(file);
db.run('CREATE TABLE IF NOT EXISTS wishlist (wishlist TEXT, title TEXT, buy TEXT, price REAL, want INTEGER, got INTEGER, priority TEXT)');

program
    .version(package.version)
    .usage('[options] <command>...');

program
    .command('update')
    .description('Processes the files in the specified directory')
    .action(function() {
    	var fancy = new Fancy('1QJBF75CZDO9E');
    	fancy.update(function(err, status) {
    		if (err) return console.log(err);

    		console.log();
    		console.log('%d items imported into the wishlist', status.totalItems);
    		console.log();
    	})
    });

program
	.command('list [query]')
	.description('searches the wishlist')
	.action(function(query) {
		var fancy = new Fancy('1QJBF75CZDO9E');
		fancy.list(query, function(err, items) {
			if (err) return console.log(err);

			items.forEach(function(item) {
				console.log(item.title + ' - ' + item.price);
			});

			console.log();
			console.log('Found %d items', items.length);
			console.log();
		});
	});

program.parse(process.argv);
